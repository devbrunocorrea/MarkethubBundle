#!/usr/bin/env php
<?php

/*
 * This file is part of gpupo/markethub-bundle
 * Created by Gilmar Pupo <contact@gpupo.com>
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 * For more information, see <https://opensource.gpupo.com/>.
 */

namespace Gpupo\MarketBundle\Console;

require dirname(__DIR__).'/config/bootstrap.php';

use Symfony\Component\Console\Output\ConsoleOutput;
use Symfony\Component\Finder\Finder;
use Gpupo\Common\Tools\Inspect;

$output = new ConsoleOutput();
$finder = new Finder();
$finder->files()->in('./vendor/gpupo/*sdk/src/')->name("*Command.php")->notName('*Abstract*');
$inspect = new Inspect();

$template = <<<'EOF'

        <!-- Command %3$s | %s -->
        <service id="%2$s" class="%2$s" public="true">
            <argument type="service" id="markethub.%6$s.factory"/>
            <tag name="console.command" />
        </service>
        <service id="%1$s" alias="%2$s" />

EOF;

$templateXml = <<<'EOF'
<?xml version="1.0" ?>
<container xmlns="http://symfony.com/schema/dic/services"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">
    <services>
        <!-- auto generated at %s -->
        %s
    </services>
 </container>

EOF;

$string = '';

foreach ($finder as $file) {
    $class = $inspect->getClassFullNameFromFile($file->getRealPath());
    $command = new $class();
    $exploded = explode(':', $command->getName());
    $id = implode('.', $exploded);
    $string .= sprintf($template,  $command->getName(), $class, $command->getDescription(), $id,  $class, $exploded[1]);
}

$xmlContent = sprintf($templateXml, (new \DateTime())->format('Y-m-d H:i:s'), $string);

$xmlFile = 'src/Bridge/Symfony/Bundle/Resources/config/autogenerated.commands.xml';
$fp = fopen($xmlFile, 'w');
fwrite($fp, $xmlContent);
fclose($fp);

$output->writeln(sprintf('File <bg=green;fg=black> %s </> generated!', $xmlFile));
